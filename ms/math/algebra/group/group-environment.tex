\startenvironment group-environment

\setupbodyfont
[palatino]
%[pagella]

\usemodule
[abr-02,narrowtt]

\definecolor[lightgray][r=0.75,g=0.75,b=0.75]
\definecolor[gray][r=0.5,g=0.5,b=0.5]

%\definecolor[maincolor][.75(orange)]
%\definecolor[titlecolor][0.75(orange)]
\definecolor[maincolor][lightgray]
\definecolor[titlecolor][lightgray]
\definecolor [Top] [h=a5b291]
\definecolor [Bottom] [h=b7c1a7]
\definecolor [TitleColor] [h=96433a]

\define[1]\titlefont{%
    \setcharacterkerning[extrakerning]%
    \cap
    \definedfont[#1]%
    \ignorespaces
}

\setupwhitespace
[big]

\setuptyping
[color=maincolor]

\setuptype
[color=maincolor]

\setupitemgroup
[itemize]
[each]
[color=titlecolor,
    symcolor=maincolor]

\setupcaptions
[color=maincolor]

\setuphead
[chapter]
[
    before=,
    after={\blank[2*big]},
    style=\bfc,
    color=maincolor,
    %command=\bookTitle
]

\setuphead
[section]
[before={\blank[2*big]},
    after=\blank,
    style=\bfb,
    color=maincolor]

\setuphead
[subsection]
[before=\blank,
    after=\blank,
    style=\bfa,
    color=maincolor]

\setuplayout
[width=middle,
    height=middle,
    header=0cm,
    topspace=2cm,
    bottomspace=1cm,
    footer=1cm,
    footerdistance=.5cm]

\setupfootertexts
[][{\getmarking[chapter]\hbox to 2em{\hss\pagenumber}}]
[{\hbox to 2em{\pagenumber\hss}\getmarking[chapter]}][]

\setuppagenumbering
[alternative=doublesided]

\startMPextensions
% color maincolor ; maincolor := \MPcolor{maincolor} ;
string maincolor ; maincolor := "maincolor" ;
\stopMPextensions

\setupenumerations
[
    before={\blank[big]},
    after={\blank[big]},
    location=serried,
    width=broad,
    distance=0.5em,
    headstyle=bold,
    titlestyle=bold,
    prefix=yes,
    prefixsegments=chapter:section,
    way=bytext,
    inbetween=\blank,
    %numberstopper={.},
    %conversion=numbers
]
% \defineenumeration
% [theorem]
% [
%     text=Theorem,
%     title=yes,
%     style=italic,
%     list=all,
%     listtext={Theorem }
% ]
% \defineenumeration
% [definition]
% [
%     text=Definition,
%     title=yes,
%     style=italic,
%     list=all,
%     listtext={Definition }
% ]

\definemeasure[frameoffset][2ex]
\definemeasure[rulethickness][0.5pt]

\defineframedtext
[theoremframe]
[
    frame=off,
    leftframe=on,
    bottomframe=on,
    framecolor=maincolor,
    rulethickness=\measure{rulethickness},
    width=broad,
    offset=overlay,
    loffset=\measure{frameoffset},
    boffset=\measure{frameoffset},
    toffset=-\measure{rulethickness},
]

\defineframed
[headframed]
[
    background=color,
    backgroundcolor=maincolor,
    foregroundcolor=white,
    frame=off,
    toffset=0.25ex,
    boffset=0.25ex,
    roffset=1ex,
    loffset=\measure{frameoffset},
    location=low,
]

\defineenumeration
[theorem]
[
    text=Theorem,
    % Number
    prefix=yes,
    prefixsegments={chapter:section},
    way=bysection,
    numbercommand={\hskip-\measure{frameoffset}\relax\headframed},
    % Title
    title=yes,
    titlecolor=titlecolor,
    titleleft=,
    titleright=,
    % Frame
    before=\starttheoremframe,
    after=\stoptheoremframe,
]

\defineenumeration
[definition]
[
    text=Definition,
    % Number
    prefix=yes,
    prefixsegments={chapter:section},
    way=bysection,
    numbercommand={\hskip-\measure{frameoffset}\relax\headframed},
    % Title
    title=yes,
    titlecolor=titlecolor,
    titleleft=,
    titleright=,
    % Frame
    before=\starttheoremframe,
    after=\stoptheoremframe,
]

\input group-lettrine.tex

\stopenvironment
